<template>
  <div class="vulnerability-wrapper">
    <h2 align="center" class="text-h2 mb-9 vulnerability-title">{{ vulnerability }}</h2>
    <component
      v-if="requestComponent"
      :is="requestComponent"
      @response-data="getResponse"
      :requestConfig="vulnerabilityConfig"
    ></component>
    <component
      :is="responseComponent"
      v-if="showResult"
      :responseConfig="responseType"
      :responseData="responseData"
      :responseDataPropertyName="responseDataPropertyName"
    ></component>
  </div>
</template>

<script>
import jsonpath from "jsonpath";

import { ref, computed, reactive, onMounted, defineComponent } from "vue";
import { useStore } from "vuex";
import HtmlComponent from "@/components/responses/HtmlComponent.vue";
import TableComponent from "@/components/responses/TableComponent.vue";
import StringComponent from "@/components/responses/StringComponent.vue";
import OctetStreamComponent from "@/components/responses/OctetStreamComponent.vue";
import ImageComponent from "@/components/responses/ImageComponent.vue";
import ObjectComponent from "@/components/responses/ObjectComponent.vue";
import BooleanComponent from "@/components/responses/BooleanComponent.vue";
import PostComponent from "@/components/requests/PostComponent.vue";
import GetComponent from "@/components/requests/GetComponent.vue";
import NavigationListComponent from "../components/NavigationListComponent.vue";
import { getResponseComponent } from "@/utils/responseComponentDesider";

export default defineComponent({
  name: "check-vulnerability-component",
  components: {
    HtmlComponent,
    TableComponent,
    StringComponent,
    OctetStreamComponent,
    PostComponent,
    GetComponent,
    ImageComponent,
    ObjectComponent,
    BooleanComponent,
    NavigationListComponent,
  },
  props: {
    vulnerability: {
      type: String,
      required: true,
    },
  },
  setup(props) {
    const store = useStore();
    const responseData = ref({});
    const showResult = ref(false);
    const requestComponent = ref("");
    const responseComponent = ref("");
    const vulnerabilityConfig = ref({});
    const responseType = ref("");
    const responseDataPropertyName = ref("");
    const swaggers = reactive({});
    onMounted(async () => {
      await store.dispatch("loadSwaggerData");
      const swagger = computed(() => store.state.swaggerData);

      vulnerabilityConfig.value = getVulnerabilityConfig(swagger);
      requestComponent.value = resolveRequestComponent(
        vulnerabilityConfig.value.method
      );
      responseComponent.value = getResponseComponent(vulnerabilityConfig.value);
      responseType.value = getResponseSchema(vulnerabilityConfig.value);
      responseDataPropertyName.value = Object.keys(
        jsonpath.query(
          vulnerabilityConfig.value,
          "$..responses['200']..properties"
        )[0] || { result: "result" }
      )[0];
    });

    const getResponseSchema = (vulnerabilityConfig) => {
      const responseType = Object.keys(
        jsonpath.query(vulnerabilityConfig, `$..responses['200'].content`)[0]
      )[0];
      if (responseType) {
        return responseType;
      }
    };
    const resolveRequestComponent = (method) => {
      // resolve the request component based on the method of the request
      const componentMap = {
        get: "GetComponent",
        post: "PostComponent",
      };
      return componentMap[method] || "StringComponent";
    };

    const getVulnerabilityConfig = (swagger) => {
      let result = {
        ...swagger.value.paths.filter((x) => x.path === props.vulnerability)[0],
      };
      // add the method and the url to the vulnerabilityConfig
      result["method"] = Object.keys(result).filter((x) => x !== "path")[0];
      result["url"] = swagger.value.servers[0]["url"] + props.vulnerability;
      return result;
    };

    const getResponse = (data) => {
      responseData.value = data;
      if (data) {
        showResult.value = true;
      }
    };

    return {
      showResult,
      requestComponent,
      responseComponent,
      vulnerabilityConfig,
      swaggers,
      responseData,
      getResponse,
      responseType,
      responseDataPropertyName,
    };
  },
});
</script>
<style>
.vulnerability-wrapper {
  padding: 1.5em 0 ;
  flex-grow: 1;
  flex-basis: 550px;
  max-width: 800px;
}
.vulnerability-title {
  word-break: break-all;
}
.wrapper-sheet {
  width: 100%;
  margin: 0 auto 1.2em;
  padding: 1.5em;
}
</style>